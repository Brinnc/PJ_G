<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>내껨</title>
    <style>
        body {
            margin: 0%;
        }

        #wrapper {
            width: 1280px;
            height: 1000px;
            background-color: black;
            /*background: url(./images/nintendo_rm.png);*/
            background-repeat: no-repeat;
            background-size: 1280px 1000px;
            margin: auto;
            text-align: center;
            position: relative;
        }

        #info {
            width: 150px;
            height: 800px;
            background: lightgray;
            position: relative;
            margin-left: 315px;
            margin-top: 100px;
            float: left;
            border: 5px solid rgb(59, 58, 58);
            box-sizing: border-box;
        }

        #logo {
            width: 100px;
            height: 100px;
            margin-top: 650px;
            position: relative;
        }

        #stage {
            width: 500px;
            height: 800px;
            background-color: forestgreen;
            position: relative;
            overflow: hidden;
            margin: auto;
            margin-top: 100px;
            float: left;
            border: 5px solid rgb(59, 58, 58);
            box-sizing: border-box;
        }
    </style>
    <script src="lib.js"></script>
    <script src="GameObject.js"></script>
    <script src="Player.js"></script>
    <script src="HP.js"></script>
    <script src="Ramen.js"></script>
    <script src="MonsterBall.js"></script>
    <script src="Pokemon.js"></script>
    <script src="Boss.js"></script>
    <script src="Digimon.js"></script>
    <script src="PokemonImg_Stage.js"></script>
    <script src="DigimonImg_Stage.js"></script>
    <script>
        let info; //상단바
        let hp; //hp하트
        let stage; //게임화면
        let player; //플레이어 캐릭터
        let monsterBall; //총알
        let pokemon; //일반몬스터
        let boss; //보스몬스터
        let digimon; //함정몬스터
        let ramen; //hp포션
        let index = 0; //스테이지 인덱스에 접근할 변수

        let bgY = 0; //stage배경의 y축 값 변수

        let ballArray = []; //기본몬스터볼을 보관할 배열


        //포켓몬 이미지경로 배열
        //let pokemonImg = ["po1.png", "po2.png", "po3.png", "po4.png", "po5.png", "po6.png", "po7.png", "po8.png", "po9.png", "po10.png"];
        let pokemonArray = []; //포켓몬 인스턴스를 담는 배열

        let bossImg = ["boss1.png", "boss2.png", "거북왕.png", "리자몽.png", "이상해꽃.png"]; //보스 이미지 경로 배열
        let bossArray = []; //보스 인스턴스 배열

        //디지몬 이미지경로 배열
        //let digimonImg = ["digi1.png", "digi2.png"];
        let digimonArray = []; //디지몬 인스턴스를 담는 배열

        //HP를 모을 배열
        let hpArray = []; //크기x, 에러남;
        let h = -1; //hpArray에 접근할 index

        //HP포션을 배열에 넣기
        let ramenArray = [];

        //스테이지 배경 이미지 배열
        let bgArray = ["bg1.jpg", "bg2.png", "임시배경.png", "임시배경.png", "임시배경.png"];

        let flag = true;


        //---------------------------------------------------------------------------------------------------------


        //1) 배경을 세팅함
        function setBG() {
            stage.style.background = "url(./images/" + bgArray[index] + ")";
            stage.style.backgroundSize = "500px 800px";
        }

        //1-1) 배경 움직이기, 위에서 아래로(y++)
        function bgEffect() {
            bgY = bgY + 1;
            stage.style.backgroundPosition = "0px " + bgY + "px";
        }

        //2) 플레이어 캐릭터 생성
        function createPlayer() {
            //container, src, width, height, x, y, velX, velY
            player = new Player(stage, "./images/rosa&roy_resize.png", 150, 150, 200, 720, 0, 0);
        }
        //2-1) 플레이어가 좌우로 이동
        function movePlayerX(n) {
            player.velX = n;
            //alert("왜 안눌러짐?");
        }

        //3) 몬스터볼 생성
        function ball() {
            //container, src, width, height, x, y, velX, velY
            monsterBall = new MonsterBall(stage, "./images/ball_basic.png", 20, 20, player.x + 70, player.y, 0, -10);

            //생성된 볼을 배열에 추가
            ballArray.push(monsterBall);
        }

        //4) 포켓몬 생성 : 스테이지 당 등장하는 포켓몬의 수가 다르게
        function createPokemon() {
            for (let i = 0; i < pokemonImg_Stage[index].length; i++) {
                //container, src, width, height, x, y, velX, velY
                //최초 등장시 랜덤한 x축, y축값 위치, 속도
                pokemon = new Pokemon(stage, "./images/" + pokemonImg_Stage[index][i], 50, 50, getRandomByRange(10, 450), getRandomByRange(-1000, 0), 0, getRandomByRange(2, 5));

                //생성된 포켓몬을 배열에 담기
                pokemonArray.push(pokemon);
            }
        }

        //7) 디지몬 생성
        function createDigimon() {
            for (let i = 0; i < digimonImg_Stage[index].length; i++) {
                //container, src, width, height, x, y, velX, velY
                digimon = new Digimon(stage, "./images/" + digimonImg_Stage[index][i], 50, 50, getRandomByRange(10, 450), getRandomByRange(-1000, 0), 0, 3);

                digimonArray.push(digimon);
            }
        }

        //5) 보스 생성
        function createBoss() {
            //container, src, width, height, x, y, velX, velY
            //최초 등장시 랜덤한 x축값 위치
            //x축 왔다갔다..? 움직이도록 하려면
            //보스몬스터는 일반포켓몬이 다나오고 나서 나와야할텐데

            boss = new Boss(stage, "./images/" + bossImg[index], 100, 100, getRandomByRange(10, 450), getRandomByRange(-1100, -1000), 0, 2);
            bossArray.push(boss);
        }

        //8) HP 생성해 인포에 표시
        function setHP() {
            for (let i = 1; i <= 7; i++) {
                //container, src, width, height, x, y, velX, velY
                hp = new HP(info, "./images/heart.png", 50, 50, 50, i * 50, 0, 0);

                hpArray.push(hp);
            }
        }

        //6) HP포션(컵라면) 생성
        function createRamen() {
            ramen = new Ramen(stage, "./images/ramen.png", 50, 50, getRandomByRange(10, 450), getRandomByRange(-1000, -800), 0, 3);
            ramenArray.push(ramen);
        }

        //9) 다음 스테이지로
        function nextStage() {
            if(index>=pokemonImg_Stage.length){
                alert("THE END");
                pause();
            }
            //pokemonArray 배열의 길이가 0이되고
            //BossArray 배열의 길이가 0이 되었을 때
            if(pokemonArray.length<=0 && bossArray.length<=0){
                if(index<=pokemonArray.length-1){
                    alert("다음 스테이지로"); //계속 호출되면 안됨

                }

                index++;
                setBG();
                createPokemon();
                createDigimon();
                createBoss();

            }
        }

        /*게임 일시정지*/
        function pause() {
            flag = !flag;
        }

        function init() {
            info = document.getElementById("info");
            stage = document.getElementById("stage");

            setBG();
            setHP();

            createPlayer();
            createPokemon();
            createBoss();
            createDigimon();

            createRamen();

        }

        function loop() {
            if (flag) {
                bgEffect();

                //플레이어의 tick()과 render()호출
                player.tick();
                player.render();

                //몬스터볼 tick()과 render()호출
                for (let i = 0; i < ballArray.length; i++) {
                    ballArray[i].tick();
                    ballArray[i].render();
                }

                //포켓몬의 tick()과 render()호출
                for (let i = 0; i < pokemonArray.length; i++) {
                    pokemonArray[i].tick();
                    pokemonArray[i].render();
                }

                //보스몬스터의 tick()과 render()호출
                for (let i = 0; i < bossArray.length; i++) {
                    bossArray[i].tick();
                    bossArray[i].render();
                }

                //디지몬의 tick()과 render()호출
                for (let i = 0; i < digimonArray.length; i++) {
                    digimonArray[i].tick();
                    digimonArray[i].render();
                }

                //hp라면의 tick()과 render()호출
                ramen.tick();
                ramen.render();

                nextStage();
            }
        }

        addEventListener("load", function () {
            init();

            setInterval("loop()", 30);

            //키보드 누를 때
            document.body.addEventListener("keydown", function (e) {
                switch (e.keyCode) {
                    case 37: movePlayerX(-10); break; //플레이어 좌, ←
                    case 39: movePlayerX(10); break; //플레이어 우, →

                    case 32: ball(); break; //볼 던지기, 스페이스

                    case 27: pause(); break; //게임스탑
                }
            });
            //키보드 뗄 때
            document.body.addEventListener("keyup", function (e) {
                switch (e.keyCode) {
                    case 37: movePlayerX(0); break; //플레이어 좌
                    case 39: movePlayerX(0); break; //플레이어 우
                }
            });
        });
    </script>
</head>

<body>
    <div id="wrapper">
        <div id="info">
            <span id="stage_text">STAGE 01</span>
            <img src="./images/Rlogo.png" id="logo">
        </div>
        <div id="stage"></div>
    </div>
</body>

</html>